# Vulnerability MTTR Tracking and KPIs

## Overview

This document defines Key Performance Indicators (KPIs) and metrics for tracking Mean Time To Resolution (MTTR) of security vulnerabilities in containerized environments, providing comprehensive measurement and reporting capabilities.

## Key Performance Indicators (KPIs)

### Primary Metrics

#### 1. Vulnerability MTTR by Severity
- **Critical Vulnerabilities**: Target MTTR ≤ 24 hours
- **High Vulnerabilities**: Target MTTR ≤ 72 hours  
- **Medium Vulnerabilities**: Target MTTR ≤ 7 days
- **Low Vulnerabilities**: Target MTTR ≤ 30 days

#### 2. Detection Metrics
- **Mean Time To Detection (MTTD)**: Average time from vulnerability publication to detection
- **Scan Coverage**: Percentage of images scanned within 24 hours of deployment
- **False Positive Rate**: Percentage of vulnerability alerts that are false positives

#### 3. Response Metrics
- **Mean Time To Acknowledgment (MTTA)**: Time from detection to team acknowledgment
- **Mean Time To Containment (MTTC)**: Time from detection to risk mitigation
- **Mean Time To Recovery (MTTR)**: Time from detection to complete resolution

#### 4. Compliance Metrics
- **Policy Compliance Rate**: Percentage of deployments meeting security policies
- **Vulnerability Backlog**: Number of unresolved vulnerabilities by age
- **SLA Adherence**: Percentage of vulnerabilities resolved within SLA targets

## Metrics Collection Framework

### Data Sources
```yaml
# CloudWatch metrics configuration
MetricFilters:
  VulnerabilityDetected:
    LogGroupName: /aws/inspector/findings
    FilterPattern: '[timestamp, severity="CRITICAL" || severity="HIGH"]'
    MetricTransformation:
      MetricName: VulnerabilitiesDetected
      MetricNamespace: Security/Vulnerabilities
      MetricValue: "1"
      DefaultValue: 0

  VulnerabilityResolved:
    LogGroupName: /aws/codebuild/security-patches
    FilterPattern: '[timestamp, status="SUCCEEDED", action="PATCH_DEPLOYED"]'
    MetricTransformation:
      MetricName: VulnerabilitiesResolved
      MetricNamespace: Security/Vulnerabilities
      MetricValue: "1"
      DefaultValue: 0
```

### Vulnerability Tracking Database Schema
```sql
-- Vulnerability tracking table
CREATE TABLE vulnerability_tracking (
    id UUID PRIMARY KEY,
    cve_id VARCHAR(20) NOT NULL,
    severity VARCHAR(10) NOT NULL,
    affected_image VARCHAR(255) NOT NULL,
    affected_pods TEXT[],
    detection_timestamp TIMESTAMP NOT NULL,
    acknowledgment_timestamp TIMESTAMP,
    containment_timestamp TIMESTAMP,
    resolution_timestamp TIMESTAMP,
    status VARCHAR(20) DEFAULT 'OPEN',
    assigned_team VARCHAR(50),
    resolution_method VARCHAR(100),
    business_impact VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_vulnerability_severity ON vulnerability_tracking(severity);
CREATE INDEX idx_vulnerability_status ON vulnerability_tracking(status);
CREATE INDEX idx_vulnerability_detection_time ON vulnerability_tracking(detection_timestamp);
```

### Automated Metrics Collection
```python
#!/usr/bin/env python3
# vulnerability-metrics-collector.py

import boto3
import json
import psycopg2
from datetime import datetime, timedelta
import logging

class VulnerabilityMetricsCollector:
    def __init__(self):
        self.cloudwatch = boto3.client('cloudwatch')
        self.inspector = boto3.client('inspector2')
        self.db_connection = self._connect_database()
        
    def collect_vulnerability_metrics(self):
        """Collect and publish vulnerability metrics"""
        
        # Get current vulnerabilities
        vulnerabilities = self._get_current_vulnerabilities()
        
        # Calculate MTTR metrics
        mttr_metrics = self._calculate_mttr_metrics()
        
        # Publish metrics to CloudWatch
        self._publish_metrics(mttr_metrics)
        
        # Update tracking database
        self._update_tracking_database(vulnerabilities)
        
    def _get_current_vulnerabilities(self):
        """Retrieve current vulnerabilities from Inspector"""
        response = self.inspector.list_findings(
            filterCriteria={
                'findingStatus': [
                    {'comparison': 'EQUALS', 'value': 'ACTIVE'}
                ]
            }
        )
        return response['findings']
    
    def _calculate_mttr_metrics(self):
        """Calculate MTTR metrics from tracking database"""
        cursor = self.db_connection.cursor()
        
        # MTTR by severity
        mttr_query = """
        SELECT 
            severity,
            AVG(EXTRACT(EPOCH FROM (resolution_timestamp - detection_timestamp))/3600) as mttr_hours,
            COUNT(*) as resolved_count
        FROM vulnerability_tracking 
        WHERE status = 'RESOLVED' 
        AND resolution_timestamp >= NOW() - INTERVAL '30 days'
        GROUP BY severity
        """
        
        cursor.execute(mttr_query)
        mttr_results = cursor.fetchall()
        
        # MTTD calculation
        mttd_query = """
        SELECT 
            AVG(EXTRACT(EPOCH FROM (detection_timestamp - created_at))/3600) as mttd_hours
        FROM vulnerability_tracking 
        WHERE detection_timestamp >= NOW() - INTERVAL '30 days'
        """
        
        cursor.execute(mttd_query)
        mttd_result = cursor.fetchone()
        
        return {
            'mttr_by_severity': mttr_results,
            'mttd_hours': mttd_result[0] if mttd_result else 0
        }
    
    def _publish_metrics(self, metrics):
        """Publish metrics to CloudWatch"""
        
        # Publish MTTR metrics by severity
        for severity, mttr_hours, count in metrics['mttr_by_severity']:
            self.cloudwatch.put_metric_data(
                Namespace='Security/Vulnerabilities',
                MetricData=[
                    {
                        'MetricName': 'MTTR',
                        'Dimensions': [
                            {'Name': 'Severity', 'Value': severity}
                        ],
                        'Value': mttr_hours,
                        'Unit': 'None',
                        'Timestamp': datetime.utcnow()
                    },
                    {
                        'MetricName': 'ResolvedCount',
                        'Dimensions': [
                            {'Name': 'Severity', 'Value': severity}
                        ],
                        'Value': count,
                        'Unit': 'Count',
                        'Timestamp': datetime.utcnow()
                    }
                ]
            )
        
        # Publish MTTD metric
        self.cloudwatch.put_metric_data(
            Namespace='Security/Vulnerabilities',
            MetricData=[
                {
                    'MetricName': 'MTTD',
                    'Value': metrics['mttd_hours'],
                    'Unit': 'None',
                    'Timestamp': datetime.utcnow()
                }
            ]
        )

if __name__ == "__main__":
    collector = VulnerabilityMetricsCollector()
    collector.collect_vulnerability_metrics()
```

## Dashboard and Reporting

### CloudWatch Dashboard Configuration
```json
{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["Security/Vulnerabilities", "MTTR", "Severity", "CRITICAL"],
          [".", ".", ".", "HIGH"],
          [".", ".", ".", "MEDIUM"],
          [".", ".", ".", "LOW"]
        ],
        "period": 86400,
        "stat": "Average",
        "region": "us-west-2",
        "title": "Vulnerability MTTR by Severity (Hours)",
        "yAxis": {
          "left": {
            "min": 0
          }
        }
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["Security/Vulnerabilities", "VulnerabilitiesDetected"],
          [".", "VulnerabilitiesResolved"]
        ],
        "period": 3600,
        "stat": "Sum",
        "region": "us-west-2",
        "title": "Vulnerability Detection vs Resolution Rate"
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["Security/Vulnerabilities", "MTTD"]
        ],
        "period": 86400,
        "stat": "Average",
        "region": "us-west-2",
        "title": "Mean Time To Detection (Hours)"
      }
    }
  ]
}
```

### Automated Reporting
```python
#!/usr/bin/env python3
# vulnerability-report-generator.py

import boto3
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import seaborn as sns
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage

class VulnerabilityReportGenerator:
    def __init__(self):
        self.cloudwatch = boto3.client('cloudwatch')
        self.ses = boto3.client('ses')
        
    def generate_weekly_report(self):
        """Generate weekly vulnerability metrics report"""
        
        # Collect metrics data
        metrics_data = self._collect_metrics_data()
        
        # Generate visualizations
        charts = self._create_visualizations(metrics_data)
        
        # Create report content
        report_html = self._create_report_html(metrics_data, charts)
        
        # Send report via email
        self._send_report_email(report_html, charts)
        
    def _collect_metrics_data(self):
        """Collect metrics data from CloudWatch"""
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(days=7)
        
        # Get MTTR metrics
        mttr_response = self.cloudwatch.get_metric_statistics(
            Namespace='Security/Vulnerabilities',
            MetricName='MTTR',
            Dimensions=[],
            StartTime=start_time,
            EndTime=end_time,
            Period=86400,
            Statistics=['Average']
        )
        
        # Get detection/resolution counts
        detection_response = self.cloudwatch.get_metric_statistics(
            Namespace='Security/Vulnerabilities',
            MetricName='VulnerabilitiesDetected',
            StartTime=start_time,
            EndTime=end_time,
            Period=86400,
            Statistics=['Sum']
        )
        
        resolution_response = self.cloudwatch.get_metric_statistics(
            Namespace='Security/Vulnerabilities',
            MetricName='VulnerabilitiesResolved',
            StartTime=start_time,
            EndTime=end_time,
            Period=86400,
            Statistics=['Sum']
        )
        
        return {
            'mttr': mttr_response['Datapoints'],
            'detections': detection_response['Datapoints'],
            'resolutions': resolution_response['Datapoints']
        }
    
    def _create_visualizations(self, metrics_data):
        """Create visualization charts"""
        charts = {}
        
        # MTTR trend chart
        plt.figure(figsize=(10, 6))
        mttr_df = pd.DataFrame(metrics_data['mttr'])
        if not mttr_df.empty:
            mttr_df['Timestamp'] = pd.to_datetime(mttr_df['Timestamp'])
            plt.plot(mttr_df['Timestamp'], mttr_df['Average'])
            plt.title('Vulnerability MTTR Trend (Last 7 Days)')
            plt.xlabel('Date')
            plt.ylabel('MTTR (Hours)')
            plt.xticks(rotation=45)
            plt.tight_layout()
            plt.savefig('/tmp/mttr_trend.png')
            charts['mttr_trend'] = '/tmp/mttr_trend.png'
            plt.close()
        
        # Detection vs Resolution chart
        plt.figure(figsize=(10, 6))
        detection_df = pd.DataFrame(metrics_data['detections'])
        resolution_df = pd.DataFrame(metrics_data['resolutions'])
        
        if not detection_df.empty and not resolution_df.empty:
            detection_df['Timestamp'] = pd.to_datetime(detection_df['Timestamp'])
            resolution_df['Timestamp'] = pd.to_datetime(resolution_df['Timestamp'])
            
            plt.plot(detection_df['Timestamp'], detection_df['Sum'], label='Detected', marker='o')
            plt.plot(resolution_df['Timestamp'], resolution_df['Sum'], label='Resolved', marker='s')
            plt.title('Vulnerability Detection vs Resolution')
            plt.xlabel('Date')
            plt.ylabel('Count')
            plt.legend()
            plt.xticks(rotation=45)
            plt.tight_layout()
            plt.savefig('/tmp/detection_resolution.png')
            charts['detection_resolution'] = '/tmp/detection_resolution.png'
            plt.close()
        
        return charts
    
    def _create_report_html(self, metrics_data, charts):
        """Create HTML report content"""
        
        # Calculate summary statistics
        total_detected = sum([dp['Sum'] for dp in metrics_data['detections']])
        total_resolved = sum([dp['Sum'] for dp in metrics_data['resolutions']])
        avg_mttr = sum([dp['Average'] for dp in metrics_data['mttr']]) / len(metrics_data['mttr']) if metrics_data['mttr'] else 0
        
        html_content = f"""
        <html>
        <head>
            <title>Weekly Vulnerability Metrics Report</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 20px; }}
                .header {{ background-color: #f0f0f0; padding: 20px; border-radius: 5px; }}
                .metric {{ display: inline-block; margin: 10px; padding: 15px; background-color: #e8f4f8; border-radius: 5px; }}
                .metric-value {{ font-size: 24px; font-weight: bold; color: #2c3e50; }}
                .metric-label {{ font-size: 14px; color: #7f8c8d; }}
                .chart {{ margin: 20px 0; text-align: center; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Weekly Vulnerability Metrics Report</h1>
                <p>Report Period: {datetime.now().strftime('%Y-%m-%d')} (Last 7 Days)</p>
            </div>
            
            <h2>Key Metrics Summary</h2>
            <div class="metric">
                <div class="metric-value">{total_detected}</div>
                <div class="metric-label">Vulnerabilities Detected</div>
            </div>
            <div class="metric">
                <div class="metric-value">{total_resolved}</div>
                <div class="metric-label">Vulnerabilities Resolved</div>
            </div>
            <div class="metric">
                <div class="metric-value">{avg_mttr:.1f}h</div>
                <div class="metric-label">Average MTTR</div>
            </div>
            <div class="metric">
                <div class="metric-value">{((total_resolved/total_detected)*100 if total_detected > 0 else 0):.1f}%</div>
                <div class="metric-label">Resolution Rate</div>
            </div>
            
            <h2>Trend Analysis</h2>
            <div class="chart">
                <img src="cid:mttr_trend" alt="MTTR Trend Chart" style="max-width: 100%;">
            </div>
            <div class="chart">
                <img src="cid:detection_resolution" alt="Detection vs Resolution Chart" style="max-width: 100%;">
            </div>
            
            <h2>Recommendations</h2>
            <ul>
                <li>Continue monitoring MTTR trends for early identification of process issues</li>
                <li>Focus on reducing detection time through improved scanning automation</li>
                <li>Maintain resolution rate above 95% for critical and high severity vulnerabilities</li>
                <li>Review and update vulnerability response procedures quarterly</li>
            </ul>
        </body>
        </html>
        """
        
        return html_content

# Automated report scheduling
if __name__ == "__main__":
    generator = VulnerabilityReportGenerator()
    generator.generate_weekly_report()
```

## SLA Monitoring and Alerting

### SLA Violation Detection
```yaml
# CloudWatch alarm for MTTR SLA violations
Resources:
  CriticalMTTRAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: CriticalVulnerabilityMTTRViolation
      AlarmDescription: Alert when critical vulnerability MTTR exceeds 24 hours
      MetricName: MTTR
      Namespace: Security/Vulnerabilities
      Dimensions:
        - Name: Severity
          Value: CRITICAL
      Statistic: Average
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 24
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref SecurityEscalationTopic

  HighMTTRAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: HighVulnerabilityMTTRViolation
      AlarmDescription: Alert when high vulnerability MTTR exceeds 72 hours
      MetricName: MTTR
      Namespace: Security/Vulnerabilities
      Dimensions:
        - Name: Severity
          Value: HIGH
      Statistic: Average
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 72
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref SecurityNotificationTopic
```

### Performance Benchmarking
```python
# Benchmark comparison script
def compare_mttr_performance():
    """Compare current MTTR performance against industry benchmarks"""
    
    industry_benchmarks = {
        'CRITICAL': 24,  # hours
        'HIGH': 72,      # hours
        'MEDIUM': 168,   # hours (7 days)
        'LOW': 720       # hours (30 days)
    }
    
    current_mttr = get_current_mttr_metrics()
    
    performance_report = {}
    for severity, benchmark in industry_benchmarks.items():
        current = current_mttr.get(severity, float('inf'))
        performance_report[severity] = {
            'current_mttr': current,
            'benchmark': benchmark,
            'performance': 'GOOD' if current <= benchmark else 'NEEDS_IMPROVEMENT',
            'variance_percent': ((current - benchmark) / benchmark) * 100
        }
    
    return performance_report
```

## Continuous Improvement Framework

### Monthly Review Process
1. **Metrics Analysis**: Review MTTR trends and identify patterns
2. **Process Evaluation**: Assess effectiveness of current response procedures
3. **Tool Assessment**: Evaluate scanning and remediation tool performance
4. **Training Needs**: Identify team training requirements based on metrics
5. **Process Updates**: Update procedures based on lessons learned

### Quarterly Benchmarking
- Compare performance against industry standards
- Assess tool effectiveness and ROI
- Review and update SLA targets
- Conduct process maturity assessment

This comprehensive MTTR tracking framework provides detailed visibility into vulnerability management performance and enables continuous improvement of security response capabilities.